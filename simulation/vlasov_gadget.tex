\chapter{Comparaison entre Gadget et un code Vlasov\label{Chap::VlasovGadget}}
	% \label{Chap::VlasovGadget}
	\minitoc%

	Une des questions qui se posent avec notre approche concerne sa validité. En effet, à quel point gadget peut il
	être proche d'un programme résolvant directement les équations de Vlasov-Poisson. Dans ce chapitre, nous tentons
	d'apporter des éléments de réponse.

	Pour comparer ces deux codes, nous nous baserons sur~\cite{1983PASJ...35..547F}.

	\section{Description du code Vlasov}

		Le code auquel nous allons comparer Gadget a été écrit par Thierry Sousbie et s'inspire grandement de
		\citet{1983PASJ...35..547F}. Pour résoudre l'équation de Valsov, nous effectuons un changement de
		coordonnées pour passer des positions-vitesses au jeu de variable utilisant la vitesse radiale
		algébrique $u$, le rayon $r$ et le moment cinétique $j$. Ensuite, la fonction de distribution $f(r, u, j)$ est échantillonnée sur
		un maillage cubique.

		L'évolution de ce maillage se fait en considérant chaque point comme une particule libre. Le déplacement
		de chaque particule se fait en décomposant l'équation de Vlasov en résolvant le système suivant pour:
		\begin{align}
			\begin{cases}
				\dfrac{\partial f}{\partial t} + u\dfrac{\partial f}{\partial r} + \dfrac{j^2}{r^3}\dfrac{\partial f}{\partial u} = 0 \\
				\\
				\dfrac{\partial f}{\partial t} - \dfrac{GM_r}{r^2}\dfrac{\partial f}{\partial u} = 0
			\end{cases} \label{Eq::VlasovGadget::EvoMaillage}
			\intertext{avec:}
			M_r = \int_0^r 4\pi r^2\rho(r)\mathrm{dr} \notag
			\intertext{et}
			\rho(r, t) = r^{-2}\int_0^\infty\mathrm{dj}2\pi j\int_{-\infty}^\infty\mathrm{du}f(r, u, j, t) \notag
		\end{align}
		Chaque équation du système est résolue pour un demi pas de temps l'une après l'autre.
		La première équation du système~\ref{Eq::VlasovGadget::EvoMaillage} donne le mouvement libre d'une
		particule tandis que la seconde donne l'accélération s'appliquant à cette dernière.
		Ensuite, pour porter les modifications des positions des particules à la grille, une interpolation,
		faîte à l'aide de spline, est utilisée.

		Au niveau de l'échantillonnage, s'il est simple au niveau des vitesses et du moment cinétique, le rayon
		pose plusieurs soucis. En effet, du fait des grandes valeurs autorisé et de la volonté des gens d'avoir
		une bonne résolution au centre, il est impératif d'utiliser une échelle logarithmique: il n'est donc pas
		possible d'aller jusqu'à $r=0$, il faut descendre jusqu'à $r=R_\mathrm{min}$. Pour modéliser ce qui se
		passe dans l'intervalle $\left[0; R_\mathrm{min}\right]$, le code utilise un \og kernel\fg. Dans ce
		kernel, le mouvement des particules est simulé en considérant qu'elles se déplacent sans qu'aucune
		force ne s'applique. Il faut donc choisir $R_\mathrm{min}$ de sorte à ce que cette hypothèse soit vrai.

		Une limite du code, venant des interpolations, c'est que les discontinuités du profil doivent être
		lissées.
		Nous allons donc utiliser une sphère de Hénon légèrement modifié: nous multiplions la fonction de
		distribution par la fonction:
		\begin{align*}
			g(r) = \mathrm{erf}\( \dfrac{r_\mathrm{max} - r }{ r_\epsilon }\) + 1
		\end{align*}
		où $r_\mathrm{max}$ est le rayon de l'objet, $r_\epsilon$ le rayon sur lequel la sphère sera lissée.


	\section{Comportement de Gadget}

		La première chose à faire est de regarder comment gadget se comporte en fonction de deux paramètres
		importants: le pas de temps et le paramètre de lissage de la force.

		Pour regarder comment évolue ce pas de temps, nous demandons à gadget de sortir les pas de temps
		individuel de chaque particules. Le graphique~\ref{Fig::VlasovGadget::PasDeTemps} nous montre
		l'évolution de ce pas de temps.

		\begin{figure}[h]
			\begin{center}
				%
				\caption{Évolution du pas de temps d'une particule.\label{Fig::VlasovGadget::PasDeTemps}}
			\end{center}
		\end{figure}


	\section{Comparaison}
		\subsection{À $\gamma=-0.5$}
			Here, the most important graphics are the phase space comparison and the
			density profile showing we get the $r^{-4}$ halo.

			First of all, we should compare the two method and see
			if they give the same results on a school case: a
			smoothed hénon 	sphere with a viriel of $\gamma=-0.5$. For checking
			this, we are looking at the phase space and the mass
			density. For the setup and the units system, we use the
			same as \cite{1983PASJ...35..547F}.

			\begin{figure}
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						\includegraphics[width=\linewidth]{{gadget_t0_J0.426_a0.5}.png}
						\caption{Phase space: radial velocity
						against radius, at $t=0$ and
						$\gamma=-0.5$ for the gadget code.}
						\label{Fig::0.5::gadget::phase_space::t0}
					\end{center}
				\end{minipage}\hfill
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						\includegraphics[width=\linewidth]{{Vlasov_ps_0.5_0.426_t0}.png}
						\caption{Phase space at $t=0$ and for
						$\gamma=-0.5$ for the vlasov code.}
						\label{Fig::0.5::vlasov::phase_space::t0}
					\end{center}
				\end{minipage}
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						%\includegraphics[width=\linewidth]{{gadget_t50_density_a0.5}.png}
						Still re-calculating...
						\caption{Phase space: radial velocity
						against radius, at $t=0$ and
						$\gamma=-0.5$ for the gadget code.}
						\label{Fig::0.5::gadget::density::t0}
					\end{center}
				\end{minipage}\hfill
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						\includegraphics[width=\linewidth]{{Vlasov_density_0.5_t0}.png}
						\caption{Phase space at $t=0$ and for
						$\gamma=-0.5$ for the vlasov code.}
						\label{Fig::0.5::vlasov::density::t0}
					\end{center}
				\end{minipage}
			\end{figure}

			\begin{figure}
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						\includegraphics[width=\linewidth]{{gadget_t100_J0.426_a0.5}.png}
						\caption{Phase space: radial velocity
						against radius, at $t=100$ and
						$\gamma=-0.5$ for the gadget code.}
						\label{Fig::0.5::gadget::phase_space::t100}
					\end{center}
				\end{minipage}\hfill
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						\includegraphics[width=\linewidth]{{Vlasov_ps_0.5_0.426_t100}.png}
						\caption{Phase space at $t=100$ and for
						$\gamma=-0.5$ for the vlasov code.}
						\label{Fig::0.5::vlasov::phase_space::t100}
					\end{center}
				\end{minipage}
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						%\includegraphics[width=\linewidth]{{gadget_t100_density_a0.5}.png}
						Still re-calculating...
						\caption{Phase space: radial velocity
						against radius, at $t=0$ and
						$\gamma=-0.5$ for the gadget code.}
						\label{Fig::0.5::gadget::density::t100}
					\end{center}
				\end{minipage}\hfill
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						\includegraphics[width=\linewidth]{{Vlasov_density_0.5_t100}.png}
						\caption{Phase space at $t=0$ and for
						$\gamma=-0.5$ for the vlasov code.}
						\label{Fig::0.5::vlasov::density::t100}
					\end{center}
				\end{minipage}
			\end{figure}

			Figure~\ref{Fig::0.5::gadget::phase_space::t0}
			and~\ref{Fig::0.5::vlasov::phase_space::t0} show the phase
			space at $t=0$ and for the angular momentum $J=0.426$ for our simulation, while
			figure~\ref{Fig::0.5::gadget::density::t0}
			and~\ref{Fig::0.5::vlasov::density::t0} show the mass
			density. All of these quantities are similar, and we get
			the expected slope.
		\subsection{À $\gamma=-0.1$}
			We are now going to test the limit of those code, for
			this purpose we try some colder homogeneous sphere. So
			we use a viriel of $\gamma=-0.1$ and we compare both
			code after a hundred unit of time. Those are shown on
			figure~\ref{Fig::0.1::gadget::phase_space::t100}
			and~\ref{Fig::0.1::gadget::density::t100}
			against~\ref{Fig::0.1::vlasov::phase_space::t100}
			and~\ref{Fig::0.1::vlasov::density::t100}; the two first
			show the Gadget-2 results and the two last the vlasov
			ones.

			\begin{figure}
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						\includegraphics[width=\linewidth]{{gadget_t100_J0.426_a0.1}.png}
						\caption{Phase space at $t=100$
							and $\gamma=-0.1$ for the gadget code.}
						\label{Fig::0.1::gadget::phase_space::t100}
					\end{center}
				\end{minipage}\hfill
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						\includegraphics[width=\linewidth]{{Vlasov_ps_0.1_0.426_t100}.png}
						\caption{Phase space at $t=100$ and for
						$\gamma=-0.1$ for the vlasov code.}
						\label{Fig::0.1::vlasov::phase_space::t100}
					\end{center}
				\end{minipage}
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						\includegraphics[width=\linewidth]{{gadget_t60_density_a0.1}.png}
						\caption{Mass density, at $t=60$ and
						$\gamma=-0.1$ for the gadget code.}
						\label{Fig::0.1::gadget::density::t100}
					\end{center}
				\end{minipage}\hfill
				\begin{minipage}{0.45\linewidth}
					\begin{center}
						\includegraphics[width=\linewidth]{{Vlasov_density_0.1_t100}.png}
						\caption{Phase space at $t=60$ and for
						$\gamma=-0.1$ for the vlasov code.}
						\label{Fig::0.1::vlasov::density::t100}
					\end{center}
				\end{minipage}
			\end{figure}
			At this point, the gadget code still gives some good
			result, as the phase space doesn't show any kind of
			instability. The density profile itself is the same as
			the vlasov simulation. To be sure that nothing important
			has happened, we plot the axial ratio on
			figure~\ref{Fig::0.1::gadget::axial_ratio}. What we call
			axial ratio is the ratio between each eigenvalue of the
			inertial matrix. Actually, the axial ratio  have change
			of $10\%$, so nothing particular happens during the
			simulation.
			\begin{figure}
				\begin{center}
					\includegraphics[width=\linewidth]{{gadget_ar_a0.1}.png}
					\caption{Axial ration evolution for the
					Gadget-2 simulation.}
					\label{Fig::0.1::gadget::axial_ratio}
				\end{center}
			\end{figure}
		\subsection{À $\gamma=-0.01$}
			We were hoping to see gadget failed when the viriel goes
			to $0$. For the last virial, gadget was successful, let
			see what happened when we divide it by ten.

			The figure~\ref{Fig::0.01::gadget::phase_space::t100}
			show us the phase space, which is also clean, the
			density profile is also close of the $\gamma=-0.1$
			profile, but this time the object lose his spherical
			symmetry.
			\begin{figure}
				\begin{center}
					\includegraphics[width=\linewidth]{{gadget_t100_J0.0828_a0.01}.png}
					\caption{Phase space at $t=100$ for
					$\gamma=-0.01$.}
					\label{Fig::0.01::gadget::phase_space::t100}
				\end{center}
			\end{figure}
			\begin{figure}
				\begin{center}
					\includegraphics[width=\linewidth]{{Smoothed_0.01-axial_ratio}.png}
					\caption{Axial ratio evolution along the
					time for $\gamma=-0.01$.}
					\label{Fig::0.01::gadget::axial_ratio}
				\end{center}
			\end{figure}

			\begin{figure}
				\begin{center}
					\includegraphics[width=\linewidth]{{Smoothed_0.01-density}.png}
					\caption{Density profile at different
					time for $\gamma=-0.01$.}
					\label{Fig::0.01::gadget::density}
				\end{center}
			\end{figure}

